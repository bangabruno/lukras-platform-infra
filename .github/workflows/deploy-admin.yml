name: Deploy module Admin

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: "Tag da imagem (ex: latest ou sha)"
        required: false
        default: "latest"
        type: string

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: us-east-1
  PROJECT_NAME: lukras-platform
  ECR_REPO: 659528245383.dkr.ecr.us-east-1.amazonaws.com/lukras-platform-admin
  TF_WORKING_DIR: admin

jobs:
  deploy-admin:
    runs-on: ubuntu-latest
    environment: prod

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials (role to assume)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: us-east-1

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Pull latest image (verify existence)
        run: |
          echo "Checking if image exists in ECR..."
          IMAGE="${{ env.ECR_REPO }}:${{ github.event.inputs.image_tag }}"
          aws ecr describe-images \
            --repository-name lukras-platform-admin \
            --image-ids imageTag=${{ github.event.inputs.image_tag }} \
            >/dev/null || {
              echo "âŒ Image tag '${{ github.event.inputs.image_tag }}' not found in ECR."
              exit 1
            }
          echo "âœ… Found image: $IMAGE"

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.5

      - name: Terraform Init (admin only)
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: |
          terraform init -upgrade

      - name: Terraform Apply (admin module only)
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: |
          terraform apply \
            -auto-approve \
            -target=module.admin \
            -var="aws_region=${{ env.AWS_REGION }}" \
            -var="project_name=${{ env.PROJECT_NAME }}" \
            -var="telegram_chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
            -var="telegram_bot_token=${{ secrets.TELEGRAM_BOT_TOKEN }}" \
            -var="admin_container_image=${{ env.ECR_REPO }}:${{ github.event.inputs.image_tag }}"

      - name: Force new ECS deployment
        run: |
          SERVICE_NAME="${{ env.PROJECT_NAME }}-admin"
          CLUSTER_ARN=$(aws ecs list-clusters --query "clusterArns[?contains(@, '${{ env.PROJECT_NAME }}-cluster')]" --output text)
          echo "ðŸ”„ Forcing new ECS deployment for $SERVICE_NAME in cluster $CLUSTER_ARN"
          aws ecs update-service \
            --cluster "$CLUSTER_ARN" \
            --service "$SERVICE_NAME" \
            --force-new-deployment >/dev/null
          echo "âœ… ECS service '$SERVICE_NAME' updated successfully"
