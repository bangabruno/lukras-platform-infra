name: Deploy module Admin

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: "Tag da imagem (ex: latest ou sha)"
        required: false
        default: "latest"
        type: string

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: us-east-1
  PROJECT_NAME: lukras-platform
  ECR_REPO: 659528245383.dkr.ecr.us-east-1.amazonaws.com/lukras-platform-admin
  TF_WORKING_DIR: .

jobs:
  deploy-admin:
    runs-on: ubuntu-latest
    environment: prod

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials (role to assume)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: us-east-1

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Pull latest image (verify existence)
        id: get_image
        run: |
          echo "Checking if image exists in ECR..."
          IMAGE_TAG="${{ github.event.inputs.image_tag }}"
          
          aws ecr describe-images \
            --repository-name lukras-platform-admin \
            --image-ids imageTag=${IMAGE_TAG} \
            >/dev/null || {
              echo "‚ùå Image tag '${IMAGE_TAG}' not found in ECR."
              exit 1
            }
          
          DIGEST=$(aws ecr describe-images \
            --repository-name lukras-platform-admin \
            --image-ids imageTag=${IMAGE_TAG} \
            --query "imageDetails[0].imageDigest" \
            --output text)
          
          FULL_IMAGE="${{ env.ECR_REPO }}@${DIGEST}"
          
          echo "‚úÖ Found image: $FULL_IMAGE"
          echo "image_uri=${FULL_IMAGE}" >> $GITHUB_OUTPUT

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.5

      - name: Terraform Init (root)
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform init -upgrade

      - name: Terraform Apply (admin module only)
        working-directory: ${{ env.TF_WORKING_DIR }}
        env:
          TF_INPUT: "0"
          TF_IN_AUTOMATION: "1"
        run: |
          echo "üöÄ Deploying with image: ${{ steps.get_image.outputs.image_uri }}"
          
          # CR√çTICO: Passar TODAS as vari√°veis necess√°rias, incluindo a vari√°vel users
          # mesmo que n√£o esteja sendo alterada (sen√£o Terraform vai usar cached value)
          terraform apply \
            -auto-approve \
            -input=false \
            -lock-timeout=5m \
            -target=module.admin \
            -var="aws_region=${{ env.AWS_REGION }}" \
            -var="project_name=${{ env.PROJECT_NAME }}" \
            -var="telegram_chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
            -var="telegram_bot_token=${{ secrets.TELEGRAM_BOT_TOKEN }}" \
            -var="admin_container_image=${{ steps.get_image.outputs.image_uri }}" \
            -var='users={}' \
            -var='enable_alb=false' \
            -var='container_image=dummy' \
            -var='cpu=256' \
            -var='memory=512' \
            -var='container_port=8080'

      - name: Force new ECS deployment
        env:
          CLUSTER_NAME: ${{ env.PROJECT_NAME }}-cluster
        run: |
          SERVICE_NAME="${{ env.PROJECT_NAME }}-admin"
          
          # Obter a √∫ltima task definition registrada
          NEW_TD_ARN=$(aws ecs list-task-definitions \
            --family-prefix "$SERVICE_NAME" \
            --sort DESC --max-items 1 \
            --query "taskDefinitionArns[0]" --output text)

          echo "‚úÖ Found latest task definition: $NEW_TD_ARN"

          # For√ßar novo deployment
          aws ecs update-service \
            --cluster "$CLUSTER_NAME" \
            --service "$SERVICE_NAME" \
            --task-definition "$NEW_TD_ARN" \
            --force-new-deployment \
            --no-cli-pager

          echo "üöÄ ECS service '$SERVICE_NAME' updated with force-new-deployment"
          
          # Aguardar deployment estabilizar
          echo "‚è≥ Waiting for deployment to complete..."
          aws ecs wait services-stable \
            --cluster "$CLUSTER_NAME" \
            --services "$SERVICE_NAME"
          
          echo "‚úÖ Deployment completed successfully!"

      - name: Verify running tasks
        env:
          CLUSTER_NAME: ${{ env.PROJECT_NAME }}-cluster
        run: |
          SERVICE_NAME="${{ env.PROJECT_NAME }}-admin"
          
          # Verificar tasks rodando
          TASKS=$(aws ecs list-tasks \
            --cluster "$CLUSTER_NAME" \
            --service-name "$SERVICE_NAME" \
            --query "taskArns" --output json)
          
          echo "Running tasks: $TASKS"
          
          if [ "$TASKS" = "[]" ]; then
            echo "‚ùå No tasks running!"
            exit 1
          fi
          
          # Pegar detalhes da primeira task
          TASK_ARN=$(echo "$TASKS" | jq -r '.[0]')
          
          aws ecs describe-tasks \
            --cluster "$CLUSTER_NAME" \
            --tasks "$TASK_ARN" \
            --query "tasks[0].{Status:lastStatus,Health:healthStatus,Image:containers[0].image}" \
            --output table
          
          echo "‚úÖ Deployment verification complete"