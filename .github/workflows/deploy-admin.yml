name: Deploy Admin

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: "Image tag to deploy (default: latest)"
        required: false
        default: "latest"

env:
  AWS_REGION: us-east-1
  PROJECT_NAME: lukras-platform
  ECR_REPO: 659528245383.dkr.ecr.us-east-1.amazonaws.com/lukras-platform-admin
  TF_WORKING_DIR: .

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.8

      - name: Terraform Init
        run: terraform init -upgrade

      - name: Terraform Apply (admin module only)
        run: |
          terraform apply \
            -auto-approve \
            -target=module.admin \
            -var="aws_region=${{ env.AWS_REGION }}" \
            -var="project_name=${{ env.PROJECT_NAME }}" \
            -var="telegram_chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
            -var="telegram_bot_token=${{ secrets.TELEGRAM_BOT_TOKEN }}" \
            -var="admin_container_image=${{ env.ECR_REPO }}:${{ github.event.inputs.image_tag }}"
