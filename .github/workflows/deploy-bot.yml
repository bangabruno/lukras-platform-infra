name: Deploy Bot to ECS

on:
  workflow_dispatch:
    inputs:
      user:
        description: "UsuÃ¡rio do bot (ou 'all' para todos)"
        required: true
        default: "all"

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Deploy Bots
        shell: bash
        run: |
          set -euo pipefail

          INPUT_USER="${{ github.event.inputs.user }}"
          echo "User requested: $INPUT_USER"

          if [[ "$INPUT_USER" == "all" ]]; then
            echo "==> Deploy para TODOS os usuÃ¡rios definidos no terraform.tfvars"
            USERS=$(grep -o '"[^"]*"' terraform.tfvars | tr -d '"' | sed '1d') # remove project_name
          else
            echo "==> Deploy somente para: $INPUT_USER"
            USERS="$INPUT_USER"
          fi

          for USER in $USERS; do
            SERVICE_NAME="lukras-platform-$USER"
            echo ""
            echo "--------------------------------------------------"
            echo "Atualizando service: $SERVICE_NAME"
            echo "--------------------------------------------------"

            aws ecs update-service \
              --cluster "lukras-platform-cluster" \
              --service "$SERVICE_NAME" \
              --force-new-deployment

            echo "âœ… Deployment aplicado para: $SERVICE_NAME"
          done

          echo ""
          echo "ðŸŽ¯ Deploy Finalizado com Sucesso ðŸŽ¯"
